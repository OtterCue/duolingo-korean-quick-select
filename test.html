<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duolingo Korean Quick Select - í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f7f7f7;
        }

        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #3c3c3c;
            margin-bottom: 10px;
        }

        .instruction {
            color: #777;
            margin-bottom: 30px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
            border-left: 4px solid #1cb0f6;
        }

        .answer-area {
            min-height: 60px;
            border-bottom: 2px solid #e5e5e5;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            align-items: center;
        }

        .word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 30px;
            min-height: 100px;
        }

        button[data-test*="challenge-tap-token"] {
            padding: 12px 20px;
            font-size: 18px;
            font-weight: 600;
            border: 2px solid #e5e5e5;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.1s;
            min-width: 80px;
            position: relative;
        }

        button[aria-disabled="true"] {
            background-color: #e5e5e5;
            color: #afafaf;
            border-color: transparent;
            cursor: default;
        }

        button[data-test*="challenge-tap-token"]:not([aria-disabled="true"]):hover {
            border-color: #1cb0f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .current-input {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 8px;
            font-family: monospace;
            font-size: 16px;
        }

        .shortcuts {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .kqs-error {
            background: rgba(255, 82, 82, 0.95) !important;
            color: white !important;
            animation: shake 0.2s cubic-bezier(.36, .07, .19, .97) both;
        }

        .kqs-input-display-sim {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(28, 176, 246, 0.95);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            font-weight: bold;
            z-index: 999999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.1s ease;
        }

        .kqs-input-display-sim.visible {
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        /* --- ìˆ˜ì •ëœ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ (content.jsì™€ ë™ì¼) --- */
        /* í›„ë³´ (íŒŒë€ìƒ‰) */
        .korean-quick-select-highlight {
            background-color: white !important;
            color: #1cb0f6 !important;
            border: 2px solid #1cb0f6 !important;
            transition: all 0.1s ease;
            transform: scale(1.02);
            z-index: 10 !important;
        }

        .korean-quick-select-highlight * {
            background-color: transparent !important;
            color: #1cb0f6 !important;
            text-shadow: none !important;
        }

        /* í™•ì • (ì´ˆë¡ìƒ‰) */
        .korean-quick-select-exact-match {
            background-color: white !important;
            color: #58cc02 !important;
            border: 2px solid #58cc02 !important;
            box-shadow: 0 0 0 2px #58cc02 !important;
            transform: scale(1.05);
            z-index: 11 !important;
        }

        .korean-quick-select-exact-match * {
            background-color: transparent !important;
            color: #58cc02 !important;
            text-shadow: none !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ‡°ğŸ‡· Duolingo Korean Quick Select í…ŒìŠ¤íŠ¸</h1>

        <div class="instruction">
            <strong>í…ŒìŠ¤íŠ¸ ëª©í‘œ:</strong> ê¸€ìê°€ ë¬´ì¡°ê±´ ì˜ ë³´ì—¬ì•¼ í•¨.<br>
            - í›„ë³´(ì—¬ëŸ¬ ê°œ): í° ë°°ê²½ + <strong>íŒŒë€ ê¸€ì”¨</strong> + íŒŒë€ í…Œë‘ë¦¬<br>
            - ì„ íƒ(í•œ ê°œ): í° ë°°ê²½ + <strong>ì´ˆë¡ ê¸€ì”¨</strong> + ì´ˆë¡ í…Œë‘ë¦¬
        </div>

        <div class="current-input">
            í˜„ì¬ ì…ë ¥: <span id="input-display">ì—†ìŒ</span>
        </div>

        <h2>ë¬¸ì œ: "íŒ€ì€ íŒ€ì„ íŒ€ê³¼ í†° ë‚˜ë„"</h2>

        <div class="answer-area" id="answer-area">
            <span style="color: #ccc; font-size: 14px;">(ì •ë‹µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤)</span>
        </div>

        <div class="word-bank" data-test="word-bank" id="word-bank">
            <button data-test="íŒ€ì€-challenge-tap-token" lang="ko" class="notranslate">íŒ€ì€</button>
            <button data-test="íŒ€ì„-challenge-tap-token" lang="ko" class="notranslate">íŒ€ì„</button>
            <button data-test="íŒ€ê³¼-challenge-tap-token" lang="ko" class="notranslate">íŒ€ê³¼</button>

            <!-- ìœ ë ¹ ë²„íŠ¼ (ë¹ˆ í…ìŠ¤íŠ¸) -->
            <button data-test="ghost-challenge-tap-token" lang="ko" class="notranslate"
                style="width: 80px; height: 50px;"></button>

            <button data-test="ë‚˜ë„-challenge-tap-token" lang="ko" class="notranslate">ë‚˜ë„</button>
            <button data-test="í†°-challenge-tap-token" lang="ko" class="notranslate">í†°</button>
        </div>

        <div class="shortcuts">
            <h3>ğŸ’¡ í…ŒìŠ¤íŠ¸ ë°©ë²•</h3>
            <ol>
                <li><code>xl</code> (í‹°) ì…ë ¥ â†’ "íŒ€ì€, íŒ€ì„, íŒ€ê³¼"ê°€ <strong>íŒŒë€ ê¸€ì”¨</strong>ë¡œ í‘œì‹œë¨.</li>
                <li><code>xh</code> (í† ) ì…ë ¥ â†’ "í†°"ì´ <strong>ì´ˆë¡ ê¸€ì”¨</strong>ë¡œ í‘œì‹œë¨.</li>
            </ol>
        </div>
    </div>

    <div id="sim-popup" class="kqs-input-display-sim">
        <div id="sim-text">ëŒ€ê¸° ì¤‘...</div>
        <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">ì´ˆì„± ë˜ëŠ” ìëª¨ ì…ë ¥</div>
    </div>

    <script>
        const inputDisplay = document.getElementById('input-display');
        const inputDisplayContainer = document.querySelector('.current-input');
        const answerArea = document.getElementById('answer-area');
        const wordBank = document.getElementById('word-bank');
        const simPopup = document.getElementById('sim-popup');
        const simText = document.getElementById('sim-text');

        function moveButton(button) {
            if (button.getAttribute('aria-disabled') === 'true') return;
            if (button.textContent.trim() === '') return;

            if (wordBank.contains(button)) {
                if (answerArea.querySelector('span')) answerArea.querySelector('span').remove();

                const clone = button.cloneNode(true);
                clone.removeAttribute('data-test');
                clone.style.cursor = 'default';
                clone.onclick = null;
                answerArea.appendChild(clone);

                button.setAttribute('aria-disabled', 'true');
                button.classList.remove('korean-quick-select-exact-match');
                button.classList.remove('korean-quick-select-highlight');
            }
        }

        document.querySelectorAll('#word-bank button').forEach(btn => {
            btn.addEventListener('click', () => moveButton(btn));
        });

        function updateInputDisplay(input) {
            inputDisplay.textContent = input || 'ì—†ìŒ';
            if (input) {
                simText.textContent = input;
                simPopup.classList.add('visible');
            } else {
                setTimeout(() => {
                    simPopup.classList.remove('visible');
                }, 1000);
            }
        }

        function showError() {
            inputDisplayContainer.classList.add('kqs-error');
            simPopup.classList.add('kqs-error');
            simPopup.classList.add('visible');
            setTimeout(() => {
                inputDisplayContainer.classList.remove('kqs-error');
                simPopup.classList.remove('kqs-error');
                if (!simulatedInput) simPopup.classList.remove('visible');
            }, 200);
        }

        let simulatedInput = '';

        const KEY_MAP = {
            'q': 'ã…‚', 'Q': 'ã…ƒ', 'w': 'ã…ˆ', 'W': 'ã…‰', 'e': 'ã„·', 'E': 'ã„¸', 'r': 'ã„±', 'R': 'ã„²', 't': 'ã……', 'T': 'ã…†',
            'a': 'ã…', 's': 'ã„´', 'd': 'ã…‡', 'f': 'ã„¹', 'g': 'ã…',
            'z': 'ã…‹', 'x': 'ã…Œ', 'c': 'ã…Š', 'v': 'ã…',
            'y': 'ã…›', 'u': 'ã…•', 'i': 'ã…‘', 'o': 'ã…', 'O': 'ã…’', 'p': 'ã…”', 'P': 'ã…–',
            'h': 'ã…—', 'j': 'ã…“', 'k': 'ã…', 'l': 'ã…£', 'b': 'ã… ', 'n': 'ã…œ', 'm': 'ã…¡'
        };

        const CHOSUNG_LIST = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
        const JUNGSUNG_LIST = ['ã…', 'ã…', 'ã…‘', 'ã…’', 'ã…“', 'ã…”', 'ã…•', 'ã…–', 'ã…—', 'ã…˜', 'ã…™', 'ã…š', 'ã…›', 'ã…œ', 'ã…', 'ã…', 'ã…Ÿ', 'ã… ', 'ã…¡', 'ã…¢', 'ã…£'];
        const COMPLEX_VOWELS = { 'ã…˜': 'ã…—ã…', 'ã…™': 'ã…—ã…', 'ã…š': 'ã…—ã…£', 'ã…': 'ã…œã…“', 'ã…': 'ã…œã…”', 'ã…Ÿ': 'ã…œã…£', 'ã…¢': 'ã…¡ã…£' };
        const HANGUL_START = 0xAC00;
        const HANGUL_END = 0xD7A3;

        function getChosung(text) {
            let chosung = '';
            for (let i = 0; i < text.length; i++) {
                const code = text.charCodeAt(i);
                if (code >= HANGUL_START && code <= HANGUL_END) {
                    const chosungIndex = Math.floor((code - HANGUL_START) / 588);
                    chosung += CHOSUNG_LIST[chosungIndex];
                } else if (CHOSUNG_LIST.includes(text[i])) {
                    chosung += text[i];
                } else {
                    chosung += text[i];
                }
            }
            return chosung;
        }

        function getDisassembled(text) {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const code = text.charCodeAt(i);
                if (code >= HANGUL_START && code <= HANGUL_END) {
                    const charCode = code - HANGUL_START;
                    const chosungIndex = Math.floor(charCode / 588);
                    const jungsungIndex = Math.floor((charCode % 588) / 28);

                    result += CHOSUNG_LIST[chosungIndex];
                    const vowel = JUNGSUNG_LIST[jungsungIndex];
                    if (COMPLEX_VOWELS[vowel]) {
                        result += COMPLEX_VOWELS[vowel];
                    } else {
                        result += vowel;
                    }
                } else {
                    result += text[i];
                }
            }
            return result;
        }

        function getWordButtons() {
            const buttons = Array.from(wordBank.querySelectorAll('button'));
            return buttons.filter(btn => {
                const style = window.getComputedStyle(btn);
                return btn.getAttribute('aria-disabled') !== 'true' &&
                    btn.textContent.trim() !== '' &&
                    style.opacity !== '0' &&
                    style.visibility !== 'hidden';
            });
        }

        function updateHighlight() {
            document.querySelectorAll('.korean-quick-select-highlight, .korean-quick-select-exact-match').forEach(el => {
                el.classList.remove('korean-quick-select-highlight', 'korean-quick-select-exact-match');
            });

            if (!simulatedInput) return;

            const buttons = getWordButtons();
            const matchedButtons = buttons.filter(button => {
                const text = button.textContent.trim();
                const chosung = getChosung(text);
                const disassembled = getDisassembled(text);
                return chosung.startsWith(simulatedInput) || disassembled.startsWith(simulatedInput);
            });

            if (matchedButtons.length > 0) {
                const allMatchedTexts = new Set(matchedButtons.map(b => b.textContent.trim()));

                if (allMatchedTexts.size === 1) {
                    const target = matchedButtons[0];
                    console.log('âœ¨ ìë™ ì„ íƒ ì‹œë„:', target.textContent.trim());
                    matchedButtons.forEach(btn => btn.classList.add('korean-quick-select-exact-match'));
                    target.click();
                    simulatedInput = '';
                    updateInputDisplay(simulatedInput);
                    setTimeout(() => {
                        matchedButtons.forEach(btn => btn.classList.remove('korean-quick-select-exact-match'));
                    }, 200);
                } else {
                    matchedButtons.forEach(btn => btn.classList.add('korean-quick-select-highlight'));
                }
            } else {
                console.log(`ğŸš« ì…ë ¥ ê±°ë¶€: "${simulatedInput}"`);
                showError();
                simulatedInput = '';
                updateInputDisplay(simulatedInput);
            }
        }

        window.addEventListener('keydown', function (event) {
            // Enter Key Simulation
            if (event.key === 'Enter') {
                const exactMatchBtn = document.querySelector('.korean-quick-select-exact-match');
                if (exactMatchBtn) {
                    event.preventDefault();
                    event.stopPropagation();
                    console.log('â†µ Enter - ë‹¨ì–´ ì„ íƒ (ì‹œë®¬ë ˆì´ì…˜):', exactMatchBtn.textContent);
                    exactMatchBtn.click();
                    simulatedInput = '';
                    updateInputDisplay(simulatedInput);
                    updateHighlight();
                    return;
                } else {
                    console.log('â†µ Enter - ê¸°ë³¸ ë™ì‘ (ì œì¶œ ì‹œë®¬ë ˆì´ì…˜)');
                    // ì‹¤ì œ ë“€ì˜¤ë§ê³ ì—ì„œëŠ” ì—¬ê¸°ì„œ ì œì¶œì´ ì¼ì–´ë‚¨
                    const feedback = document.createElement('div');
                    feedback.textContent = 'ğŸš€ ì •ë‹µ ì œì¶œ (ê¸°ë³¸ ë™ì‘)';
                    feedback.style.position = 'fixed';
                    feedback.style.top = '50%';
                    feedback.style.left = '50%';
                    feedback.style.transform = 'translate(-50%, -50%)';
                    feedback.style.background = 'rgba(0,0,0,0.8)';
                    feedback.style.color = 'white';
                    feedback.style.padding = '20px';
                    feedback.style.borderRadius = '10px';
                    feedback.style.zIndex = '10000';
                    document.body.appendChild(feedback);
                    setTimeout(() => feedback.remove(), 1000);
                }
                return;
            }

            if (event.key === 'Escape') {
                simulatedInput = '';
                updateInputDisplay(simulatedInput);
                updateHighlight();
                return;
            }

            if (event.key === 'Backspace' || event.key === 'Delete') {
                if (simulatedInput !== '') {
                    simulatedInput = simulatedInput.slice(0, -1);
                    updateInputDisplay(simulatedInput);
                    updateHighlight();
                }
                return;
            }

            let nextInput = null;
            if (KEY_MAP[event.key]) {
                nextInput = simulatedInput + KEY_MAP[event.key];
            } else if (CHOSUNG_LIST.includes(event.key) || JUNGSUNG_LIST.includes(event.key)) {
                nextInput = simulatedInput + event.key;
            }

            if (nextInput) {
                simulatedInput = nextInput;
                updateInputDisplay(simulatedInput);
                updateHighlight();
            }
        }, true);

        console.log('í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ.');
    </script>
</body>

</html>